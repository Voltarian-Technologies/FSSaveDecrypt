<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width, user-scalable=no">
  <title>PIP-BOY 55</title>
  <meta name="description" content="Pip-Boy 55, The Fallout Shelter Save Editor">

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/DeEn.js"></script>
  <script src="/js/json2.min.js"></script>
  <script src="/js/jquery-2.1.4.min.js"></script>

</head>

<body>
  <div class="pipboy-frame">
    <div class="pipboy-screen">
      <div class="pipboy-header">
        <div class="pipboy-status">
          <span class="status-indicator online"></span>
          <span class="status-text">VAULT-TEC SYSTEMS</span>
        </div>
        <div class="pipboy-time" id="current-time">00:00:00</div>
      </div>
      
      <div class="pipboy-nav">
        <div class="nav-section active" data-section="status">
          <span class="nav-icon">▣</span>
          <span class="nav-label">STATUS</span>
        </div>
        <div class="nav-section" data-section="editor">
          <span class="nav-icon">◈</span>
          <span class="nav-label">SAVE EDITOR</span>
        </div>
        <div class="nav-section" data-section="about">
          <span class="nav-icon">◉</span>
          <span class="nav-label">ABOUT</span>
        </div>
      </div>

      <div class="pipboy-content">
        <div class="content-section active" id="status-section">
          <div class="section-header">
            <h2>SYSTEM STATUS</h2>
            <div class="divider"></div>
          </div>
          <div class="status-grid">
            <div class="status-item">
              <span class="status-label">VAULT ID:</span>
              <span class="status-value">000</span>
            </div>
            <div class="status-item">
              <span class="status-label">SYSTEM:</span>
              <span class="status-value">ONLINE</span>
            </div>
            <div class="status-item">
              <span class="status-label">VERSION:</span>
              <span class="status-value">3.0.0</span>
            </div>
            <div class="status-item">
              <span class="status-label">MODE:</span>
              <span class="status-value">IDLE</span>
            </div>
          </div>
          <div class="system-message">
            <p>READY FOR FILE OPERATIONS</p>
            <p class="warning">LARGE FILES CAN TAKE MORE TIME TO PROCESS</p>
          </div>
        </div>

        <div class="content-section" id="editor-section">
          <div class="section-header">
            <h2>SAVE EDITOR</h2>
            <div class="divider"></div>
          </div>
          <div class="file-operations">
            <div class="operation-box">
              <div class="operation-header">
                <span class="operation-icon">◈</span>
                <span class="operation-title">SELECT .SAV FILE</span>
              </div>
              <div class="file-input-wrapper">
                <input hidden type="file" id="sav_file" name="sav_file" accept=".sav" class="pipboy-input">
                <label for="sav_file" class="file-input-label">
                  <span class="file-icon">◐</span>
                  <span class="file-text">CHOOSE FILE</span>
                </label>
              </div>
              <div class="operation-info">
                <p>Load and edit Fallout Shelter save files</p>
                <p class="file-type">Supported: .sav files</p>
              </div>
            </div>
            
            <div class="operation-box" id="resource-editor" style="display: none;">
              <div class="operation-header">
                <span class="operation-icon">◈</span>
                <span class="operation-title">EDIT RESOURCES</span>
              </div>
              <div class="resource-grid">
                <div class="resource-item">
                  <label class="resource-label">CAPS</label>
                  <div class="custom-input-control">
                    <button class="arrow-btn arrow-left" onclick="adjustValue('caps', -1)">◄</button>
                    <input type="number" id="caps-input" class="resource-input" min="0" max="999999" value="0" readonly>
                    <button class="arrow-btn arrow-right" onclick="adjustValue('caps', 1)">►</button>
                  </div>
                  <button class="resource-btn btn-primary" onclick="updateResource('Nuka')">SET</button>
                </div>
                <div class="resource-item">
                  <label class="resource-label">NUKA QUANTUM</label>
                  <div class="custom-input-control">
                    <button class="arrow-btn arrow-left" onclick="adjustValue('quantum', -1)">◄</button>
                    <input type="number" id="quantum-input" class="resource-input" min="0" max="9999" value="0" readonly>
                    <button class="arrow-btn arrow-right" onclick="adjustValue('quantum', 1)">►</button>
                  </div>
                  <button class="resource-btn btn-primary" onclick="updateResource('NukaColaQuantum')">SET</button>
                </div>
                <div class="resource-item">
                  <label class="resource-label">FOOD</label>
                  <div class="custom-input-control">
                    <button class="arrow-btn arrow-left" onclick="adjustValue('food', -1)">◄</button>
                    <input type="number" id="food-input" class="resource-input" min="0" max="9999" value="0" readonly>
                    <button class="arrow-btn arrow-right" onclick="adjustValue('food', 1)">►</button>
                  </div>
                  <button class="resource-btn btn-primary" onclick="updateResource('Food')">SET</button>
                </div>
                <div class="resource-item">
                  <label class="resource-label">POWER</label>
                  <div class="custom-input-control">
                    <button class="arrow-btn arrow-left" onclick="adjustValue('energy', -1)">◄</button>
                    <input type="number" id="energy-input" class="resource-input" min="0" max="9999" value="0" readonly>
                    <button class="arrow-btn arrow-right" onclick="adjustValue('energy', 1)">►</button>
                  </div>
                  <button class="resource-btn btn-primary" onclick="updateResource('Energy')">SET</button>
                </div>
                <div class="resource-item">
                  <label class="resource-label">WATER</label>
                  <div class="custom-input-control">
                    <button class="arrow-btn arrow-left" onclick="adjustValue('water', -1)">◄</button>
                    <input type="number" id="water-input" class="resource-input" min="0" max="9999" value="0" readonly>
                    <button class="arrow-btn arrow-right" onclick="adjustValue('water', 1)">►</button>
                  </div>
                  <button class="resource-btn btn-primary" onclick="updateResource('Water')">SET</button>
                </div>
              </div>
              <div class="editor-actions">
                <button class="btn-primary" onclick="saveAndDownload()">SAVE</button>
              </div>
            </div>
          </div>
        </div>

        
        <div class="content-section" id="about-section">
          <div class="section-header">
            <h2>ABOUT PIP-BOY</h2>
            <div class="divider"></div>
          </div>
          <div class="about-content">
            <div class="about-item">
              <span class="about-label">DEVICE:</span>
              <span class="about-value">PIP-BOY 55</span>
            </div>
            <div class="about-item">
              <span class="about-label">MANUFACTURER:</span>
              <span class="about-value">VAULT-TEC</span>
            </div>
            <div class="about-item">
              <span class="about-label">MODULE:</span>
              <span class="about-value">FSSaveEdit v1.0</span>
            </div>
            <div class="about-item">
              <span class="about-label">PURPOSE:</span>
              <span class="about-value">SAVE FILE EDITING</span>
            </div>
            <div class="about-description">
              <p>This Pip-Boy module provides secure editing services for Vault-Tec approved save files.</p>
              <p>All modifications are applied and downloaded securely for vault security compliance.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="pipboy-footer">
        <div class="footer-left">
          <span class="footer-text">VAULT-TEC 2077</span>
        </div>
        <div class="footer-right">
          <span class="footer-text">SYSTEM ONLINE</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Update time display
    function updateTime() {
      const now = new Date();
      const timeString = now.toTimeString().split(' ')[0];
      document.getElementById('current-time').textContent = timeString;
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Navigation functionality
    document.querySelectorAll('.nav-section').forEach(section => {
      section.addEventListener('click', function() {
        // Remove active class from all sections and content
        document.querySelectorAll('.nav-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked section and corresponding content
        this.classList.add('active');
        const targetSection = this.getAttribute('data-section') + '-section';
        document.getElementById(targetSection).classList.add('active');
        
        // Update MODE display
        const modeValue = document.querySelector('.status-item:nth-child(4) .status-value');
        const sectionName = this.getAttribute('data-section');
        if (sectionName === 'editor') {
          modeValue.textContent = 'EDITOR';
        } else {
          modeValue.textContent = 'IDLE';
        }
      });
    });

    // File input styling
    document.querySelectorAll('.pipboy-input').forEach(input => {
      input.addEventListener('change', function() {
        const label = this.nextElementSibling;
        const fileName = this.files[0]?.name || 'CHOOSE FILE';
        label.querySelector('.file-text').textContent = fileName;
      });
    });

    // Custom alert system
    function showPipboyAlert(message) {
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'pipboy-overlay';
      
      // Create alert box
      const alertBox = document.createElement('div');
      alertBox.className = 'pipboy-alert';
      
      // Create content
      const content = document.createElement('div');
      content.className = 'pipboy-alert-content';
      content.textContent = message;
      
      // Create close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'pipboy-alert-close';
      closeBtn.textContent = 'CLOSE';
      closeBtn.onclick = function() {
        document.body.removeChild(overlay);
        document.body.removeChild(alertBox);
      };
      
      // Assemble alert
      alertBox.appendChild(content);
      alertBox.appendChild(closeBtn);
      
      // Add to page
      document.body.appendChild(overlay);
      document.body.appendChild(alertBox);
      
      // Auto-close after 3 seconds
      setTimeout(function() {
        if (document.body.contains(overlay)) {
          document.body.removeChild(overlay);
          document.body.removeChild(alertBox);
        }
      }, 3000);
    }

    // Arrow button functionality - only adjusts display, not save data
    let intervalMap = {};
    
    function adjustValue(resource, delta) {
      const inputMap = {
        'caps': 'caps-input',
        'quantum': 'quantum-input',
        'food': 'food-input',
        'energy': 'energy-input',
        'water': 'water-input'
      };
      
      const maxMap = {
        'caps': 999999,
        'quantum': 9999,
        'food': 9999,
        'energy': 9999,
        'water': 9999
      };
      
      const inputId = inputMap[resource];
      const maxValue = maxMap[resource];
      
      if (!inputId) return;
      
      const input = document.getElementById(inputId);
      let currentValue = parseInt(input.value) || 0;
      let newValue = currentValue + delta;
      
      // Apply bounds
      if (newValue < 0) newValue = 0;
      if (newValue > maxValue) newValue = maxValue;
      
      input.value = newValue;
    }

    // Mouse event handlers for auto-increment
    function startIncrement(resource, delta) {
      // Clear any existing interval
      if (intervalMap[resource]) {
        clearInterval(intervalMap[resource]);
      }
      
      let incrementDelta = delta;
      let timeElapsed = 0;
      
      intervalMap[resource] = setInterval(() => {
        timeElapsed += 100;
        
        if (timeElapsed < 10000) { // First 10 seconds: +1 every second
          incrementDelta = delta;
        } else if (timeElapsed < 20000) { // Next 10 seconds: +10 every second
          incrementDelta = delta * 10;
        } else { // After 20 seconds: +100 every second
          incrementDelta = delta * 100;
        }
        
        adjustValue(resource, incrementDelta);
      }, 100);
    }

    function stopIncrement(resource) {
      if (intervalMap[resource]) {
        clearInterval(intervalMap[resource]);
        delete intervalMap[resource];
      }
    }

    // Add mouse event listeners to arrow buttons
    document.addEventListener('DOMContentLoaded', function() {
      const arrowButtons = document.querySelectorAll('.arrow-btn');
      
      arrowButtons.forEach(button => {
        button.addEventListener('mousedown', function(e) {
          e.preventDefault();
          const onclick = this.getAttribute('onclick');
          const resourceMatch = onclick.match(/adjustValue\('([^']+)'/);
          if (resourceMatch) {
            const resource = resourceMatch[1];
            const delta = onclick.includes("1)") ? 1 : -1;
            startIncrement(resource, delta);
          }
        });
        
        button.addEventListener('mouseup', function(e) {
          e.preventDefault();
          const onclick = this.getAttribute('onclick');
          const resourceMatch = onclick.match(/adjustValue\('([^']+)'/);
          if (resourceMatch) {
            const resource = resourceMatch[1];
            stopIncrement(resource);
          }
        });
        
        button.addEventListener('mouseleave', function(e) {
          e.preventDefault();
          const onclick = this.getAttribute('onclick');
          const resourceMatch = onclick.match(/adjustValue\('([^']+)'/);
          if (resourceMatch) {
            const resource = resourceMatch[1];
            stopIncrement(resource);
          }
        });
      });
    });

    // Update resource function - only saves when SET is clicked
    function updateResource(resourceType) {
      if (!currentSaveData) {
        showPipboyAlert('Please load a save file first!');
        return;
      }
      
      const inputMap = {
        'Nuka': 'caps-input',
        'NukaColaQuantum': 'quantum-input',
        'Food': 'food-input',
        'Energy': 'energy-input',
        'Water': 'water-input'
      };
      
      const inputId = inputMap[resourceType];
      if (!inputId) return;
      
      const input = document.getElementById(inputId);
      const value = parseInt(input.value) || 0;
      
      if (!currentSaveData.vault.storage.resources) {
        currentSaveData.vault.storage.resources = {};
      }
      
      currentSaveData.vault.storage.resources[resourceType] = value;
      showPipboyAlert(`${resourceType} updated to ${value}!`);
    }
    let currentSaveData = null;
    let currentFileName = '';

    // Add file input event listener for save file
    document.getElementById('sav_file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        currentFileName = file.name;
        const reader = new FileReader();
        reader.onload = function(event) {
          try {
            decryptSaveFile(event.target.result);
          } catch (error) {
            alert('Error loading save file: ' + error.message);
          }
        };
        reader.readAsText(file);
      }
    });

    function decryptSaveFile(base64Str) {
      try {
        const cipherBits = sjcl.codec.base64.toBits(base64Str);
        const prp = new sjcl.cipher.aes([2815074099, 1725469378, 4039046167, 874293617, 3063605751, 3133984764, 4097598161, 3620741625]);
        const iv = sjcl.codec.hex.toBits("7475383967656A693334307438397532");
        const plainBits = sjcl.mode.cbc.decrypt(prp, cipherBits, iv);
        const jsonStr = sjcl.codec.utf8String.fromBits(plainBits);
        
        currentSaveData = JSON.parse(jsonStr);
        
        // Extract and display vault ID
        if (currentSaveData.vault && currentSaveData.vault.VaultName) {
          const vaultId = currentSaveData.vault.VaultName;
          document.querySelector('.status-item:nth-child(1) .status-value').textContent = vaultId;
        }
        
        // Show resource editor
        document.getElementById('resource-editor').style.display = 'block';
        
        // Load current resource values
        loadResourceValues();
        
        showPipboyAlert('Save file loaded successfully!');
      } catch (error) {
        showPipboyAlert('Failed to decrypt save file: ' + error.message);
      }
    }

    function loadResourceValues() {
      if (!currentSaveData || !currentSaveData.vault || !currentSaveData.vault.storage || !currentSaveData.vault.storage.resources) {
        console.log('Cannot load resource values - missing data structure');
        return;
      }
      
      const resources = currentSaveData.vault.storage.resources;
      console.log('Loading resources:', resources);
      
      const capsInput = document.getElementById('caps-input');
      const quantumInput = document.getElementById('quantum-input');
      const foodInput = document.getElementById('food-input');
      const energyInput = document.getElementById('energy-input');
      const waterInput = document.getElementById('water-input');
      
      if (capsInput) {
        capsInput.value = resources.Nuka || 0;
        console.log('Set caps to:', resources.Nuka || 0);
      }
      if (quantumInput) {
        quantumInput.value = resources.NukaColaQuantum || 0;
        console.log('Set quantum to:', resources.NukaColaQuantum || 0);
      }
      if (foodInput) {
        foodInput.value = resources.Food || 0;
        console.log('Set food to:', resources.Food || 0);
      }
      if (energyInput) {
        energyInput.value = resources.Energy || 0;
        console.log('Set energy to:', resources.Energy || 0);
      }
      if (waterInput) {
        waterInput.value = resources.Water || 0;
        console.log('Set water to:', resources.Water || 0);
      }
    }

    function saveAndDownload() {
      if (!currentSaveData) {
        showPipboyAlert('No save file loaded!');
        return;
      }
      
      try {
        // Apply all resource values
        currentSaveData.vault.storage.resources.Nuka = parseInt(document.getElementById('caps-input').value) || 0;
        currentSaveData.vault.storage.resources.NukaColaQuantum = parseInt(document.getElementById('quantum-input').value) || 0;
        currentSaveData.vault.storage.resources.Food = parseInt(document.getElementById('food-input').value) || 0;
        currentSaveData.vault.storage.resources.Energy = parseInt(document.getElementById('energy-input').value) || 0;
        currentSaveData.vault.storage.resources.Water = parseInt(document.getElementById('water-input').value) || 0;
        
        // Create and download save file
        const compactJsonStr = JSON.stringify(currentSaveData);
        const plainBits = sjcl.codec.utf8String.toBits(compactJsonStr);
        const prp = new sjcl.cipher.aes([2815074099, 1725469378, 4039046167, 874293617, 3063605751, 3133984764, 4097598161, 3620741625]);
        const iv = sjcl.codec.hex.toBits("7475383967656A693334307438397532");
        const cipherBits = sjcl.mode.cbc.encrypt(prp, plainBits, iv);
        const base64Str = sjcl.codec.base64.fromBits(cipherBits);
        
        const blob = new Blob([base64Str], { type: "text/plain" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = currentFileName;
        link.click();
        
        showPipboyAlert('Save file created and downloaded successfully!');
      } catch (error) {
        showPipboyAlert('Error creating save file: ' + error.message);
      }
    }

  </script>
</body>
</html>